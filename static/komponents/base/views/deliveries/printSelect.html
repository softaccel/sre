<style>

</style>

<div class="modal" id="printModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    Tiparire etichete
                </div>
            </div>
            <div class="modal-body bg-light">
                <form id="listToPrintForm">

                <div id="dataForPrinting">
                    <h5><%= attributes.label %></h5>
                    <h6>De printat:</h6>
                    <div class="alert alert-default-info font-weight-bold">format: "a-b" - se printeaza toate etichetele de la a pana la b<br>     "a,b,c" - se printeaza doar etichetele a, b si c<br>
                        a, b si c sunt numere naturale mai mici decat <%= attributes.totalcnt %></div>
                    <input type="text" name="delivery" value="<%=relationships.delivery.id%>" class="d-none">
                    <input type="text" name="item" value="<%=relationships.item.id%>" class="d-none">
                    <input type="text" id="toBePrinted" name="seqList" value="1-<%=attributes.totalcnt%>" class="form-control-sm form-control" placeholder="1-5,7,9" autocomplete="off" pattern="^([0-9-,]+)$">
                </div>
                <br>
                <button type="submit" class="btn btn-success">Print</button>
                </form>
                <form id="textAreasForm" class="d-none">
                    <textarea name="label" form="textAreasForm" class="labelTextArea d-block w-100" onchange="updateTemplate(this)"><%= attributes.value %></textarea>
                </form>
                <button type="submit" form="textAreasForm" id="sendAjaxReqBtn" class="btn btn-success d-none">Save</button>
            </div>

            <div class="modal-footer">
                <button data-dismiss="modal" class="btn btn-secondary">Inchide</button>
            </div>
            <ul id="testUl" data-resourcetype="collection">
                <li><%=test%></li>
            </ul>
        </div>
    </div>
</div>

<script>


    function updateTemplate(src) {
        console.log(src)
    }
    function init_komponent(k){
        let $modal = k.$el.appendTo("body")
            .filter("#printModal")
            .on("hidden.bs.modal",function () {
                k.$el.remove();
            });
        $modal.modal("show");


        let lblInst = k.$el.find(".labelTextArea").apiator({resourcetype: "item", returninstance: true})
            .setUrl(apiRoot + "/settings/label_template.spaleck/");
        lblInst.loadFromRemote()
            .then(function () {
                console.log("lblInst",lblInst);
                k.$el.find(".labelTextArea").removeData("instance");
            });

        k.data.instance.bindView(k.$el.find("#dataForPrinting"),true).render();
        let genData = {
            teilNr:null,
            name: k.data.instance.attributes.label,
            nrDesen: null,
            cmdInt: null,
            bstlg: null,
            auftrag: null,
            total: null,
        };

        k.data.instance.getUtilities().captureFormSubmit($("#listToPrintForm"),function (data) {
            console.log("printing.....",data)
            let seq_arr = data.seqList.split(",");
            let seqNos = [];
            seq_arr.forEach(seqNo => {
                let tmp = seqNo.split("-");
                if (tmp.length === 1){
                    seqNos.push(tmp[0]);
                }
                else {
                    for(let i=tmp[0]*1;i<=tmp[1]*1;i++) {
                        if(seqNos.indexOf(i.toString())!==-1)
                            continue;
                        seqNos.push(i.toString());
                    }
                }
            });
            console.log(seqNos);

            let labelsData = [];
            $().apiator({returninstance:true,resourcetype: "item"})
                .setUrl(apiRoot+"/orders_items/"+data.item+"?include=order,order.doc_id,order.orders_meta,orders_items_meta,deliveries_contents" +
                    "&filter_advanced[deliveries_contents]=delivery="+k.data.instance.relationships.delivery.id)
                .loadFromRemote()
                .then(function (item) {
                    genData.denumire = item.attributes.name;
                    genData.cmdInt = item.relationships.order.relationships.doc_id.attributes.docnum;
                    item.relationships.orders_items_meta.forEach(function (meta) {
                        if(meta.attributes.meta_key==="cod_articol") {
                            genData.teilNr = meta.attributes.meta_val;
                        }
                        if(meta.attributes.meta_key==="numar_desen") {
                            genData.nrDesen = meta.attributes.meta_val;
                        }
                    });
                    item.relationships.order.relationships.orders_meta.forEach(function (meta) {
                        if(meta.attributes.meta_key==="bestellung") {
                            genData.bstlg = meta.attributes.meta_val;
                        }
                    });

                    if(!item.relationships.deliveries_contents) {
                        return ;
                    }

                    genData.total =  item.relationships.deliveries_contents.length;
                    item.relationships.deliveries_contents.forEach(function(dc){
                        if(seqNos.indexOf(dc.attributes.seqno)!==-1) {
                            let labelData = {
                                seqno: dc.attributes.seqno,
                                barcode:dc.id
                            };
                            Object.assign(labelData,genData);
                            labelsData.push(labelData);
                        }
                    });

                    console.log(labelsData);

                    // return ;
                    console.log("item,genData",item,genData);
                    let instance_labels = $("#textAreasForm").apiator({returninstance: true});
                    instance_labels.loadFromData(labelsData);
                    // return item;
                    let temp_arr = [];

                    $(".labelTextArea[name=label]").map(function (index, value){
                        temp_arr.push($(value).val());
                    });
                    let urlPrint = localStorage.getItem(localStorageLabel+".lblPrintApi");

                    let ajx = $
                        .ajax({
                            url: urlPrint,
                            data: JSON.stringify({labels: temp_arr}),
                            type: "POST",
                            contentType: 'application/json',
                        })
                        .done(function (xhr) {
                            $modal.modal("hide");
                        })
                        .fail(function(jqXHR){
                            let errMsg = jqXHR.status===404 ? "Imprimanta nu este configurata corect." : jqXHR.responseText;

                            komponentor.intent("/common/errormodal").data({
                                body: "A aparut o eroare:<pre>"+errMsg+"</pre>"
                            }).send();
                        });

                    instance_labels.items.forEach(function (item) {
                        item.update({label_printed: 1});
                    });
                });
        });
    }


</script>