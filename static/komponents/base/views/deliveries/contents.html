<script src="assets/js/jquery.scannerdetection.js"></script>

<style>

    #deliveryContentsTable tr>td:first-child,#deliveryContentsTable tr>th:first-child{
        display: none;
    }

    /*#deliveryContentsTable:hover tr>td:first-child,#deliveryContentsTable:hover tr>th:first-child{*/
    /*    display: table-cell;*/
    /*}*/
    .items{
        width: 100%;
        background: white;

    }
    .items td {
        font-size: 0.8rem;
        vertical-align: top;
    }
    .items td,.items th{
        border-bottom: dashed silver 1px;
    }
    .items thead{
        background: #6f6f6f;
        color: white;
    }
    .items thead a{
        color: white;

    }
    .items  input{
        border: solid silver 1px;
    }


</style>

<div class="checkRequired" data-module="deliveries" data-level="1">
    <form id="deliveryContentsFilter" class="d-none"><input type="submit"></form>
    <div class="hide-not-created">
        <button class="btn btn-primary btn-sm mb-3 checkUpdate" id="addContentBtn"><i class="fa fa-truck-loading"></i> Adauga elemente la livrare</button>
    </div>
    <div style="max-height: 500px; overflow: auto">
        <div class="alert alert-default-secondary">
            <div class="form-row">
                <div class="col">
                    <label>Numar desen</label>
                    <input type="text" autocomplete="off" name="code" class="form-control form-control-sm" form="deliveryContentsFilter" data-operator="~=~" oninput="$(this.form).submit()">
                </div>
                <div class="col">
                    <label>Denumire piesa</label>
                    <input type="text" autocomplete="off"  name="label" class="form-control form-control-sm" form="deliveryContentsFilter" data-operator="~=~" oninput="$(this.form).submit()">
                </div>
                <div class="col">
                    <label>Stare etichetare</label>
                    <select class="custom-select custom-select-sm" onchange="filterByLabelStatus(this)" form="deliveryContentsFilter">
                        <option value="">Toate</option>
                        <option value="1">Etichetate</option>
                        <option value="0">Ne-etichetate</option>
                    </select>
                </div>
                <div class="col">
                    <label>Stare incarcare</label>
                    <select class="custom-select custom-select-sm" onchange="filterByCheckoutStatus(this)" form="deliveryContentsFilter">
                        <option value="">Toate</option>
                        <option value="1">Scanate</option>
                        <option value="0">Ne-scanate</option>
                    </select>
                </div>

            </div>

        </div>
        <table class="items table table-sm" id="deliveryContentsTable">
            <thead id="deliveriesListHeader">
            <tr>
                <th></th>
                <th><input type="checkbox" id="checkAllAssignedItems" data-connected="#deliveryContentsList" onclick="toggleAll(this)"></th>
                <th class="align-top">
                    <a data-sortfld="code">Numar desen
                        <i class="fa fa-sort-up sort-up" style="display: none"></i><i class="fa fa-sort-down sort-down" style="display: none"></i><i class="fa fa-sort sort-default text-light"></i></a>
                </th>
                <th class="align-top">
                    <a data-sortfld="label">Denumire
                        <i class="fa fa-sort-up sort-up" style="display: none"></i><i class="fa fa-sort-down sort-down" style="display: none"></i><i class="fa fa-sort sort-default text-light"></i></a>
                </th>
                <th class="align-top" style="min-width: 250px">
<!--                    <a>-->
                        Comanda
<!--                        <i class="fa fa-sort-up sort-up" style="display: none"></i><i class="fa fa-sort-down sort-down" style="display: none"></i><i class="fa fa-sort sort-default text-light"></i></a>-->
<!--                    <input type="text" name="label" class="form-control-sm form-control" form="deliveryContentsFilter" data-operator="~=~" oninput="$(this.form).submit()">-->
                </th>
                <th class="align-top" style="width: 100px">
                    <a data-sortfld="totalcnt">Bucati
                        <i class="fa fa-sort-up sort-up" style="display: none"></i><i class="fa fa-sort-down sort-down" style="display: none"></i><i class="fa fa-sort sort-default text-light"></i></a>
                </th>
                <th class="align-top" style="width: 100px">
                    <a data-sortfld="printed">Etichetate
                        <i class="fa fa-sort-up sort-up" style="display: none"></i><i class="fa fa-sort-down sort-down" style="display: none"></i><i class="fa fa-sort sort-default text-light"></i></a>
                </th>
                <th class="align-top" style="width: 100px">
                    <a data-sortfld="checkout">Scanate
                        <i class="fa fa-sort-up sort-up" style="display: none"></i><i class="fa fa-sort-down sort-down" style="display: none"></i><i class="fa fa-sort sort-default text-light"></i></a>
                </th>
                <th width="70">
                    <button class="btn btn-success shadow" id="refreshButt"><i class="fa fa-retweet"></i></button>

                </th>
            </tr>
            </thead>
            <tbody id="deliveryContentsList" data-paging="#deliveryContentsListPaging" data-type="delivery_items_aggregated" data-resourcetype="collection"
                   data-pagesizeinp="#deliveryContentsPageSizeInp" data-filter="#deliveryContentsFilter" data-sort="#deliveriesListHeader">
            <tr class="">
                <td><button class="btn-success btn">OK</button></td>
                <td><input type="checkbox" name="ids[]" value="<%= id %>" onclick="toggleSelect($(this).parents('tr'))" data-connected="#checkAllAssignedItems"></td>
                <td><%= attributes.code %></td> <!-- id din orders_items -->
                <td><%= attributes.label %></td> <!-- name din idem si la fel -->
                <td><%= relationships.item.relationships? relationships.item.relationships.order.relationships.doc_id.attributes.docnum : "--" %></td> <!-- docnum din documents, relationship prin doc_id din orders -->
                <td><%= attributes.totalcnt %></td> <!-- qty din orders_items -->
                <td><%= attributes.printed %></td>
                <td><%= attributes.checkout %></td>
                <td style="min-width: 70px">
                    <div class="hide-not-created">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-danger checkDelete" onclick="removeFromDelivery(this)"><i class="fa fa-trash"></i></button>
                            <button class="btn btn-sm btn-primary checkUpdate" onclick="goToPrint(this)"><i class="fa fa-print"></i></button>
                        </div>
                    </div>
                </td>
            </tr>
            </tbody>
            <tfoot>
            <tr>
                <td></td>
                <td></td>
                <td colspan="7">
                    <div class="btn-group"  id="deliveryContentsListPaging" data-pagesize="50">
                        <button name="first" class="btn btn-sm btn-outline-secondary" title="0">&lt;&lt;</button>
                        <button name="prev" class="btn btn-sm btn-outline-secondary" title="-20">&lt;</button>
                        <button name="page" class="btn btn-sm btn-outline-secondary" title="0">1</button>
                        <button name="next" class="btn btn-sm btn-outline-secondary" title="20">&gt;</button>
                        <button name="last" class="btn btn-sm btn-outline-secondary" title="140">&gt;&gt;</button>
                    </div>
                    <select id="deliveryContentsPageSizeInp">
                        <option selected>10</option>
                        <option >25</option>
                        <option>50</option>
                    </select> inregistrari pe pagina
                </td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>

<script>


    function filterByCheckoutStatus(src) {
        let sel = $(src);
        switch (sel.val()) {
            case "":
                sel.prop("name","");
                sel.data("operator","=");
                break;
            case "1":
                sel.prop("name","checkout");
                sel.data("operator",">=");
                break;
            case "0":
                sel.prop("name","notcheckout");
                sel.data("operator",">");
        }
        $(src.form).submit();
    }

    function filterByLabelStatus(src) {
        let sel = $(src);
        switch (sel.val()) {
            case "":
                sel.prop("name","");
                sel.data("operator","=");
                break;
            case "1":
                sel.prop("name","printed");
                sel.data("operator",">=");
                break;
            case "0":
                sel.prop("name","notprinted");
                sel.data("operator",">");
        }
        $(src.form).submit();
    }

    function removeFromDelivery(src) {
        let instance = $(src).data("instance");
        komponentor.intent("/common/messagemodal").data({
            body:"Sigur vrei sa elimini elementul <strong>"+instance.attributes.label+"</strong>?",
            buttons:[
                {
                    label: "Da",
                    attrs: {
                        "data-dismiss": "modal",
                    },
                    class: "btn btn-danger",
                    callback: function () {
                        instance.setUrl({deleteUrl: apiRoot+"/deliveries_contents/?filter=item="
                                + instance.relationships.item.id
                                + ",delivery=" + instance.relationships.delivery.id});
                        instance.delete();

                    }
                },
                {
                    label: "Nu",
                    attrs: {
                        "data-dismiss": "modal",
                    },
                    class: "btn btn-secondary",
                }
            ]
        }).send();
    }

    function goToPrint(src) {
        komponentor.intent("/views/deliveries/printSelect").data({instance: $(src).data("instance")}).send();
    }



    function init_komponent(k) {

        console.log("run again");
        k.$el.addClass(k.data.instance.attributes.status);

        if(!k.data || !k.data.instance) {
            return;
        }


        let url = apiRoot + "/deliveries/"+k.data.instance.id + "/delivery_items_aggregated?include=item,item.orders_items_meta,item.order,item.order.doc_id";
        let contentItems = k.$el.find("#deliveryContentsList").apiator({returninstance:true}).setUrl(url);

        let currentDeliveryId = k.data.instance.id;

        function enableScanning() {
            if(typeof document.scannerDetectionOff!=="undefined") {
                $(document).scannerDetection(false);
            }
            $(document)
                .scannerDetection({
                    timeBeforeScanTest: 200, // wait for the next character for upto 200m0006075014s
                    endChar: [13], // be sure the scan is complete if key 13 (enter) is detected
                    avgTimeByChar: 40, // it's not a barcode if a character takes longer than 40ms
                    ignoreIfFocusOn: 'input', // turn off scanner detection if an input has focus
                    // onComplete: (code)=>scanForCheckIn(code,currentDeliveryId), // main callback function
                    onComplete: (code)=>startScanning(code), // main callback function
                    scanButtonKeyCode: 116, // the hardware scan button acts as key 116 (F5)
                    scanButtonLongPressThreshold: 5, // assume a long press if 5 or more events come in sequence
                    // onScanButtonLongPressed: longPress, // callback for long pressing the scan button
                    minLength: 2,
                    onError: function(string){alert('Error ' + string);}
                });
        }

        function startScanning(code) {
            let data = {
                deliveryId:currentDeliveryId,
                scanCode:code,
                onclose: function () {
                    console.log("callback scanning");
                    contentItems.loadFromRemote();
                    enableScanning();
                }
            };
            komponentor.intent("/views/deliveries/scan").data(data).send();
        }

        k.activate = function() {
            contentItems.loadFromRemote()
                .then(function () {
                    enableScanning();
                });
        };
        k.activate();

        k.$el.find("#startScanBut").on("click",function () {
            komponentor.intent("/views/deliveries/scan").data({data:k.data}).send();
        });

        $('#refreshButt').on("click",function () {
            contentItems.loadFromRemote();
        });

        k.$el.find("#addContentBtn").on("click",function (e) {
            komponentor.intent("/views/deliveries/selectContent").data({instance:k.data.instance,contentItems:contentItems}).send();
        });

    }


</script>