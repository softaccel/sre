<style>
    #timeTrackingEntries tr input,
    #timeTrackingEntries tr button.edit,
    #timeTrackingEntries tr select{
        display: none;
    }
    #timeTrackingEntries tr.edit p,
    #timeTrackingEntries tr.edit button{
        display: none;
    }
    #timeTrackingEntries tr.edit input,
    #timeTrackingEntries tr.edit button.edit,
    #timeTrackingEntries tr.edit select{
        display: unset;
    }
    .employeeView .emplCol{
        display: none;
    }

    .orderView .orderCol{
        display: none;

    }

</style>
<div>
    <button class="btn btn-primary" style="margin-bottom: 8px" id="newTTBtn">Introducere manuala</button>
    <form id="timeTrackingEntriesFiltering" class="d-none">
        <button type="submit" name="submit" id="submitBtn"></button>
    </form>
    <table class="table table-striped table-hover table-sm" id="timeTrackingTable">
<!--        HEADER-->
        <thead class="thead-dark">
        <tr>
            <th class="emplCol align-top" style="min-width: 150px">
                Angajat
                <select id="emplNamefilter" name="employee" class="form-control-sm form-control" form="timeTrackingEntriesFiltering" data-operator="="><option> </option></select>
            </th>
            <th class="orderCol align-top" style="min-width: 100px">
                Comanda
                <select id="docNumFilter" name="order" class="form-control-sm form-control" form="timeTrackingEntriesFiltering" data-operator="="><option> </option></select>
            </th>
            <th class="align-top" style="min-width: 150px">
                Operatie
                <select id="operationFilter" name="operation" class="form-control-sm form-control" form="timeTrackingEntriesFiltering" data-operator="="><option> </option></select>
            </th>
            <th class="align-top" style="min-width: 300px">
                <a class="text-white" data-sortfld="start">Start
                    <i class="fa fa-sort-up sort-up" style="display: none"></i><i class="fa fa-sort-down sort-down" style="display: none"></i><i class="fa fa-sort sort-default text-light"></i>
                </a>
                <div class="input-group input-group-sm ">
                    <div class="input-group-prepend">
                        <span class="input-group-text">de la</span>
                    </div>
                    <input type="datetime-local" name="start" class="form-control-sm form-control" data-operator=">=" form="timeTrackingEntriesFiltering">
                </div>
                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <span class="input-group-text">pana</span>
                    </div>
                    <input type="datetime-local" name="start" class="form-control-sm form-control" data-operator="<=" form="timeTrackingEntriesFiltering">
                </div>
            </th>
            <th class="align-top" style="min-width: 300px">
                <a class="text-white" data-sortfld="stop">Stop
                    <i class="fa fa-sort-up sort-up" style="display: none"></i><i class="fa fa-sort-down sort-down" style="display: none"></i><i class="fa fa-sort sort-default text-light"></i>
                </a>
                <div class="input-group input-group-sm ">
                    <div class="input-group-prepend">
                        <span class="input-group-text">de la</span>
                    </div>
                    <input type="datetime-local" name="stop" class="form-control-sm form-control" data-operator=">=" form="timeTrackingEntriesFiltering">
                </div>
                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <span class="input-group-text">pana</span>
                    </div>
                    <input type="datetime-local" name="stop" class="form-control-sm form-control" data-operator="<=" form="timeTrackingEntriesFiltering">
                </div>
            </th>
            <th class="align-top" style="min-width: 150px">
                <a class="text-white" data-sortfld="duration">Durata (minute)
                    <i class="fa fa-sort-up sort-up" style="display: none"></i><i class="fa fa-sort-down sort-down" style="display: none"></i><i class="fa fa-sort sort-default text-light"></i>
                </a>
                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <span class="input-group-text">min</span>
                    </div>
                    <input type="text" name="duration" class="form-control-sm form-control" data-operator=">=" form="timeTrackingEntriesFiltering">
                </div>
                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <span class="input-group-text">max</span>
                    </div>
                    <input type="text"  name="duration" class="form-control-sm form-control" data-operator="<=" form="timeTrackingEntriesFiltering">
                </div>
            </th>
            <th width="150px"></th>
        </tr>
        </thead>
<!--        HEADER STOP-->

<!--        CONTENTS-->
        <tbody id="timeTrackingEntries" data-type="timetracking" data-resourcetype="collection" data-paging="#timeTrackingEntriesPaging" data-filter="#timeTrackingEntriesFiltering"
               data-pagesizeinp="#timeTrackingEntriesLimit" data-offsetinp="#timeTrackingEntriesOffset">
        <tr>
            <td class="emplCol"><%= relationships.employee.attributes.fname %> <%= relationships.employee.attributes.lname %></td>
            <td>
                <p><%= relationships.order.relationships.doc_id.attributes.docnum %></p>
            </td>
            <td class="orderCol">
                <p><%= relationships.operation.attributes.name %></p>
                <select name="op" style="min-width: 200px"></select>
                <p><%= attributes.hourly_rate %> <%= relationships.currency.id %></p>
                <input type="number" name="hourly_rate" value="<%= attributes.hourly_rate %>" style="max-width: 60px">
                <select name="currency">
                    <option><%= relationships.currency.id %></option>
                </select>
            </td>
            <td>
                <p><%= attributes.start %></p>
                <input type="datetime-local" name="start" style="min-width: 200px">
            </td>
            <td>
                <p><%= attributes.stop %></p>
                <input type="datetime-local" name="stop" style="min-width: 200px">
            </td>
            <td>
                <p><%= attributes.duration %></p>
            </td>

            <td>
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button class="btn btn-secondary btn-sm" onclick="duplicateItem(this);"><i class="fa fa-copy" title="Duplicare"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="deleteUnit(this);" title="Stergere"><i class="fa fa-trash"></i></button>
                    <button class="btn btn-warning btn-sm" onclick="edit(this)" title="Editare"><i class="fa fa-edit"></i> </button>
                    <button class="btn btn-primary btn-sm edit" onclick="save(this)" title="Salvare"><i class="fa fa-save"></i> </button>
                    <button class="btn btn-secondary btn-sm edit" onclick="cancelEdit(this)" title="Anulare"><i class="fa fa-window-close"></i> </button>
                </div>
            </td>
        </tr>
        </tbody>
    <tfoot>
    <tr>
        <td colspan="6">
            <div class="btn-group"  id="timeTrackingEntriesPaging" data-pagesize="20">
                <button name="first" class="btn btn-outline-secondary" title="0">&lt;&lt;</button>
                <button name="prev" class="btn btn-outline-secondary" title="-20">&lt;</button>
                <button name="page" class="btn btn-outline-secondary" title="0">1</button>
                <button name="next" class="btn btn-outline-secondary" title="20">&gt;</button>
                <button name="last" class="btn btn-outline-secondary" title="140">&gt;&gt;</button>
            </div>
            Pagina <input type="number" name="offset" size="3" value="0" id="timeTrackingEntriesOffset">
            <select id="timeTrackingEntriesLimit">
                <option></option>
                <option>5</option>
                <option>10</option>
                <option>25</option>
                <option>50</option>
                <option>75</option>
            </select> inregistrari pe pagina
        </td>
    </tr>
    </tfoot>
</table>
</div>
<script>
    timeRegex = /(\d+)\:(\d+)\:(\d+)/;

    function cancelEdit(src) {
        $(src).parents('tr').removeClass('edit')
            .find("select[name=op]").select2("destroy");

    }

    function save(src) {
        let itemContainer = $(src).parents("tr");
        let opSel = itemContainer.find("select[name=op]").val();

        let startVal = itemContainer.find("input[name=start]").val();
        let stopVal = itemContainer.find("input[name=stop]").val();
        let hourly_rate = itemContainer.find("input[name=hourly_rate]").val();
        let currency = itemContainer.find("select[name=currency]").val();

        let instance = $(src).data("instance");

        if(opSel === null || startVal.length == 0 || stopVal.length == 0){
            komponentor.intent("/common/messagemodal").data({
                body: "Completati campurile \"Operatie\", \"Start\" si \"Stop\" pentru a continua.",
                buttons: [
                    {
                        label: "Ok",
                        class: "btn-secondary",
                        attrs: {
                            "data-dismiss":"modal"
                        }
                    }
                ]
            }).send();
            return;
        }

        let [oid,opid] = opSel.split("/");

        instance.update({
            operation: opid,
            order: oid,
            start: startVal.replace("T", " "),
            stop: stopVal.replace("T", " "),
            currency: currency,
            hourly_rate: hourly_rate
        }).catch(function (e) {
            komponentor.intent("/common/errormodal").data({body: "Eroare: <pre>" + e.jqXHR.responseText + "</pre>"}).send();
        });
    }

    function edit(src) {
        let itemContainer = $(src).parents("tr").addClass("edit");
        let opSel = itemContainer.find("select[name=op]");
        let instance = $(src).data("instance");

        if(opSel.hasClass("select2")) opSel.select2("destroy");
        opSel.empty().append("<option value='"+instance.relationships.order.id + "/" + instance.relationships.operation.id + "'>"
            +instance.relationships.order.relationships.doc_id.attributes.docnum + " / "
            +instance.relationships.operation.attributes.name+"</option>");

        opSel.select2wrapper({
            // url: apiRoot+"/employees/"+instance.attributes.employee+"/emplToOrdAssoc?filter=status=ord",
            url: apiRoot+"/employees/"+instance.relationships.employee.id+"/emplToOrdAssoc?filter=status!><offer,ready,dlvd",
            labelfld: function (item) {
                return item.attributes.docnum + " - " + item.attributes.opname;
            },
            idfld: function (item) {
                return item.attributes.oid + "/" + item.attributes.opid;
            },

            placeholder: "Comanda/proiect"
        });

        itemContainer.find("input[name=start]").val(instance.attributes.start);
        itemContainer.find("input[name=stop]").val(instance.attributes.stop);
        itemContainer.find("input[name=submit]");
    }

    function deleteUnit(src) {

        komponentor.intent("/common/messagemodal").data({
            body: "Esti sigur ca vrei sa stergi pontajul lui <br><strong>" + $(src).data("instance").relationships.employee.attributes.fname + " " + $(src).data("instance").relationships.employee.attributes.lname + "</strong> de <strong>" + $(src).data("instance").attributes.duration + "ore?</strong>",
            buttons: [
                {
                    label: "Da",
                    class: "btn-danger",
                    attrs: {
                        "data-dismiss": "modal"
                    },
                    callback: function () {
                        $(src).data('instance').delete().catch(function (data) {
                            komponentor.intent("/common/errormodal").data({
                                body: "A aparut o eroare:<pre>" + JSON.stringify(data.jqXHR.responseText) + "</pre>"
                            }).send();
                        });
                    }
                },
                {
                    label: "Nu",
                    class: "btn-secondary",
                    attrs: {
                        "data-dismiss": "modal"
                    }
                }
            ]
        }).send();
    }

    function duplicateItem(src) {
        let itemInstance = $(src).data("instance");
        komponentor.intent("/common/messagemodal").data({
            body: "Esti sigur ca vrei sa creezi o dublura pontajului lui <br><strong>" + itemInstance.relationships.employee.attributes.fname + " " + $(src).data("instance").relationships.employee.attributes.lname + "</strong> de <strong>" + $(src).data("instance").attributes.duration + "ore?</strong>",
            buttons: [
                {
                    label: "Da",
                    class: "btn-danger",
                    attrs: {
                        "data-dismiss": "modal"
                    },
                    callback: function () {
                        let data = itemInstance.attributes;
                        data.employee = itemInstance.relationships.employee.id;
                        data.operation = itemInstance.relationships.operation.id;
                        data.order = itemInstance.relationships.order.id;
                        data.currency = itemInstance.relationships.currency.id;
                        delete data.id;
                        itemInstance.collection.createItem(data)
                            .catch(function (data) {
                                komponentor.intent("/common/errormodal")
                                    .data({
                                        body: "A aparut o eroare:<pre>" + JSON.stringify(data.jqXHR.responseText) + "</pre>"
                                    })
                                    .send();
                            });
                    }
                },
                {
                    label: "Nu",
                    class: "btn-secondary",
                    attrs: {
                        "data-dismiss": "modal"
                    }
                }
            ]
        }).send();
    }

    function customUrl(k) {
        if (!k.data) {
            throw "Empty data";
        }

        let data = k.data;

        if(data.instance) {
            switch (data.instance.type) {
                case "employees":
                    k.$el.find("#timeTrackingTable").addClass("employeeView");
                    return apiRoot + "/timetracking?sort=-start&page[tt_expanded][offset]=0&page[tt_expanded][limit]=5&include=employee,order,order.doc_id,operation&filter=employee="+data.instance.id;
                case "orders":
                    k.$el.find("#timeTrackingTable").addClass("orderView");
                    return apiRoot + "/timetracking?sort=-start&page[tt_expanded][offset]=0&page[tt_expanded][limit]=5&include=employee,order,order.doc_id,operation&filter=order="+data.instance.id;
                default:
                    console.log(data.instance);
                    throw "Unknown type";
            }
        }

        if(data.emplid) {
            return apiRoot + "/timetracking?sort=-start&page[tt_expanded][offset]=0&page[tt_expanded][limit]=5&filter=employee="+data.emplid;
        }
    }

    function init_komponent(k) {

        let url = apiRoot + "/timetracking?sort=-start&page[tt_expanded][offset]=0&page[tt_expanded][limit]=10&include=employee,order,order.doc_id,operation";

        try {
            url = customUrl(k);
        } catch (e) {
            console.log(e)
        }

        let instance = $("#timeTrackingEntries").apiator({
            url: url,
            returninstance: true
        });

        k.$el.find("#newTTBtn").on("click", function () {
            komponentor.intent("/views/pontaj/newTTModal")
                .data({instance: instance})
                .send();
        });

        k.$el.find("#emplNamefilter").select2wrapper({
            url: apiRoot + "/employees_names",
            labelfld: "fullname",
            idfld: "id",
            placeholder: "Nume Angajat"
        })

        k.$el.find("#docNumFilter").select2wrapper({
            url: apiRoot + "/orders_extended",
            labelfld: "docnum",
            idfld: "oid",
            placeholder: "Doc num"
        });

        k.$el.find("#operationFilter").select2wrapper({
            url: apiRoot + "/catalog?filter=type=service",
            labelfld: "name",
            idfld: "id",
            placeholder: "Operatie"
        });

        let submitButton = k.$el.find("#timeTrackingEntriesFiltering").find("#submitBtn");

        $("#emplNamefilter").on("select2:select", function () {
            submitButton.click();
        }).on("select2:clear", function () {
            submitButton.click();
        });

        $("#docNumFilter").on("select2:select", function () {
            submitButton.click();
        }).on("select2:clear", function () {
            submitButton.click();
        });

        $("#operationFilter").on("select2:select", function () {
            submitButton.click();
        }).on("select2:clear", function () {
            submitButton.click();
        });

        $("#timeTrackingTable").find("input").on("change", function () {
            submitButton.click();
        });


        let util = instance.getUtilities();
        let form = $("#newTTForm")[0];

        util.captureFormSubmit(form, function (data) {
            addNewTT(data);
        })

        function addNewTT(data) {

            if (data.employee === null || data.docnum === null || data.start.length === 0 || data.stop.length === 0 || data.hourly_rate.length === 0 || data.currency === null) {

                komponentor.intent("/common/messagemodal").data({
                    body: "Completati toate campurile pentru a continua.",
                    buttons: [
                        {
                            label: "Ok",
                            class: "btn-secondary",
                            attrs: {
                                "data-dismiss": "modal"
                            }
                        }
                    ]
                }).send();
                return;
            }
            data.start = data.start.replace("T", " ")
            data.stop = data.stop.replace("T", " ")

            data.operation = data.docnum.split("/")[1];
            data.order = data.docnum.split("/")[0];

            delete data.docnum;
            instance.createItem(data).then(function () {
                $("[name=newTT]").toggle();
                instance.loadFromRemote();
            })
                .catch(function (data) {
                    komponentor.intent("/common/errormodal").data({
                        body: "A aparut o eroare:<pre>" + JSON.stringify(data.jqXHR.responseText) + "</pre>"
                    }).send();
                });

            // k.$el.find("#addNewTTBtn").on("click", addNewTT);

            k.exec = function (b) {
                console.log("exec order", k, b);
            }
        }

    }

</script>
