
<div class="card bg-light mt-2">
    <div class="card-body ">

        <div class="row">
            <div class="col-md-6"><select style="width: 100%" id="emplSel"></select>
            </div>
<!--            <div class="col-md-4">        <select style="width: 100%" id="orderSel"></select></div>-->
            <div class="col-md-6">
                <div name="reportrange" style="width: 100%;background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; display: inline-block">
                    <i class="fa fa-calendar"></i>&nbsp;
                    <span></span> <i class="fa fa-caret-down"></i>
                </div>
            </div>
        </div>
    </div>
</div>


<table class="table">
    <thead class="bg-secondary">
    <tr>
        <th>Angajat</th>
<!--        <th>Comanda</th>-->
        <th>Data</th>
        <th>Ziua saptamanii</th>
<!--        <th>Denumire comanda</th>-->
<!--        <th>Operatie</th>-->
        <th>Durata</th>
    </tr>
    </thead>
    <tbody data-resourcetype="collection" data-paging="#reportEmplTTPaging">
    <tr>
        <td><%=attributes.fname%> <%=attributes.lname%></td>
        <td><%=attributes.date%></td>
        <td><%= ['duminica','luni','marti','miercuri','joi','vineri','sambata'][(new Date(attributes.date)).getDay()]%></td>
        <td><%=attributes.duration%><%this.item.collection.minsTotal += attributes.duration*1%></td>
    </tr>
    </tbody>
    <tfoot>
    <tr class="bg-light">
        <td colspan="3">Total (ore)</td>
        <td>0</td>
    </tr>
    </tfoot>
    <tfoot id="reportEmplTTPaging"></tfoot>
</table>
<script>
    function init_komponent(k) {
        let currentEmplId = null;
        let currentOrderId = null;

        k.$el.find("#emplSel")
            .select2wrapper({
                url: apiRoot+"/employees_names",
                labelfld: "fullname",
                idfld: "id",
                placeholder: "Angajati"
            })
            .on("change",function () {
                currentEmplId = $(this).val();
                loadreport();
            });

        k.$el.find("#orderSel")
            .select2wrapper({
                url: apiRoot+"/orders_extended",
                labelfld: "docnum",
                idfld: "oid",
                placeholder: "Comenzi"
            })
            .on("change",function () {
                currentOrderId = $(this).val();
                loadreport();
            });


        var start = moment().subtract(29, 'days');
        var end = moment();

        function loadreport() {
            $('[name=reportrange] span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));

            let inst = k.$el.find("table tbody").apiator({returninstance: true});
            inst.minsTotal = 0;

            let url = apiRoot + "/report_tt_agg_byempl/?sort=-date&filter="
                +"date>="+ start.format('YYYY-MM-DD') + ",date<=" + end.format('YYYY-MM-DD')+"";

            if(currentEmplId) {
                url += ",employee="+currentEmplId;
            }
            if(currentOrderId) {
                url += ",order="+currentOrderId;
            }

            inst.setUrl(url)
                .loadFromRemote()
                .then(function () {
                    k.$el.find("table tfoot td:last").text(Math.round(inst.minsTotal*100)/100);
                });

        }

        $('[name=reportrange]').daterangepicker({
            startDate: start,
            endDate: end,
            ranges: {
                'Azi': [moment(), moment()],
                'Ieri': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Ultimele 7 zile': [moment().subtract(6, 'days'), moment()],
                'Ultimele 30 de zile': [moment().subtract(29, 'days'), moment()],
                'Luna aceasta': [moment().startOf('month'), moment().endOf('month')],
                'Luna trecuta': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        }, (s,e)=>{start=s;end=e;loadreport()});


        loadreport();

    }
</script>