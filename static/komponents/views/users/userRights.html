<style>

</style>

<div class="checkRequired" data-module="userRights" data-level="3">
    <div class="checkUpdate">
        <table class="table table-striped table-hover" style="table-layout: fixed" >
            <thead class="thead-dark">
            <tr class="text-white">
                <th>Denumire </th>
                <th>Create </th>
                <th>Read </th>
                <th>Update </th>
                <th>Delete </th>
            </tr>
            </thead>
            <tbody id="userRightsList" data-resourcetype="collection" data-type="">
            <tr>
                <td><%= attributes.module %></td>
                <td>
                    <% let rights = JSON.parse(attributes.meta_val); %>
                    <% if(rights.indexOf("c") !== -1) { %>
                    <input type="checkbox" name="create" checked>
                    <% } else { %>
                    <input type="checkbox" name="create">
                    <% } %>
                </td>
                <td>
                    <% if(rights.indexOf("r") !== -1) { %>
                    <input type="checkbox" name="read" checked>
                    <% } else { %>
                    <input type="checkbox" name="read">
                    <% } %>
                </td>
                <td>
                    <% if(rights.indexOf("u") !== -1) { %>
                    <input type="checkbox" name="update" checked>
                    <% } else { %>
                    <input type="checkbox" name="update">
                    <% } %>
                </td>
                <td>
                    <% if(rights.indexOf("d") !== -1) { %>
                    <input type="checkbox" name="delete" checked>
                    <% } else { %>
                    <input type="checkbox" name="delete">
                    <% } %>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>

    function init_komponent(k) {

        let instance = $("#userRightsList").apiator({resourcetype: "collection", returninstance: true});

        function setEvents() {
            instance.view.el.find("input[type=checkbox]").off().on("click", function (e) {
                let eventInstance = $(e.target).data("instance");

                let updateCopy = {...eventInstance.updateUrl};
                updateCopy.path = updateCopy.path.replace("/users/" + k.data.instance.id + "/users_rights/", "/users_meta");
                eventInstance.setUrl({updateUrl: updateCopy});
                eventInstance.type = "users_meta";

                let metaVal = JSON.parse(eventInstance.attributes.meta_val);
                let rightInitial = $(e.target).attr("name").slice(0,1);

                if (metaVal.indexOf(rightInitial) === -1) {
                    metaVal.push(rightInitial);
                } else {
                    metaVal.splice(metaVal.indexOf(rightInitial),1);
                }

                eventInstance.update({meta_val: JSON.stringify(metaVal)}).then(function () {
                    eventInstance.type = "users_rights";
                    updateCopy.path = updateCopy.path.replace("/users_meta", "/users/" + k.data.instance.id + "/users_rights/");
                    eventInstance.setUrl({updateUrl: updateCopy});
                    eventInstance.loadFromRemote().then(function () {
                        setEvents();
                    });
                });
            });
        }

        instance.setUrl(apiRoot + "/users/" + k.data.instance.id + "/users_rights/").loadFromRemote().then(function () {
            setEvents();
        });

        let form = $("#userRightsForm");
        let util = instance.getUtilities();

        util.captureFormSubmit(form, function (data) {
            console.log(data);
        });

    }

</script>