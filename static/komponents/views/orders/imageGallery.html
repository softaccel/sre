<style>

</style>

<div id="imageGallery">
    <br>
    <form id="imageGalleryForm">
        <input type="file" name="files[]" multiple class="" id="addFiles">
        <input type="submit" value="Upload" name="upload">
    </form>
    <div id="gallery" data-resourcetype="collection">
        <% gallery = JSON.parse(attributes.meta_val); console.log(gallery); %>
        <ul class="mt-4 d-flex flex-row justify-content-start align-items-start" style="list-style-type: none;">
            <% for(let img of gallery) { %>
            <% console.log(img) %>
            <li class="m-1 align-self-center"><img class="img-thumbnail img-fluid rounded mx-auto d-block" src="<%=img.tnp%>"></li>
            <% } %>
        </ul>
    </div>
</div>

<script>

    function init_komponent(k) {
        const galInst = k.$el.find("#gallery")
            .apiator({returninstance:true})
            .setUrl(apiRoot + "/catalog/" + k.data.instance.attributes.cat_id + "/catalog_meta/?filter=meta_key=Gallery");
        galInst.loadFromRemote();

        let form = $("#imageGalleryForm")[0];
        const util = galInst.getUtilities();

        util.captureFormSubmit(form, function (data) {
            let formData = new FormData();
            let $files = form["files[]"];
            for (var index = 0; index < $files.files.length; index++) {
                formData.append("files[]", $files.files[index]);
            }

            $.ajax({
                url : fileApiUrl,
                type : 'POST',
                data : formData,
                processData: false,
                contentType: false,
                success : function(data) {
                    let imageList = galInst.items.length ? JSON.parse(galInst.items[0].attributes.meta_val) : [];

                    console.log(data,galInst,imageList);
                    data.data.forEach(function (img){
                        console.log(img);
                        imageList.push({
                            fp: fileApiUrl+"/" + img.id,
                            tnp: fileApiUrl+"/" + img.id+"/1",
                            lbl: ""
                        });
                    });
                    console.log(imageList)


                    let p = galInst.items.length
                        ? galInst.items[0].update({meta_val:JSON.stringify(imageList)})
                        : galInst.append({meta_key:"Gallery",meta_val:JSON.stringify(imageList)})
                    p.then(function (data){
                        console.log(data);
                    })
                    .catch(function (err){
                        console.log(err);
                    });
                }
            });
        });

    }

</script>