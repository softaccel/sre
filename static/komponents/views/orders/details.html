<style>
    .order-summary-table button.save{
        display: none;
    }
    /*.order-summary-table span.display{}*/
    .editMode span.display{
        display: none;
    }
    .order-summary-table span.edit{
        display: none;
    }
    .editMode span.edit{
        display: inline-block;
        min-width: 150px;
    }
    .editMode button.edit{
        display: none;
    }
    .editMode button.save{
        display: unset;
    }

</style>
<div class="row" id="orderDetails">
    <div class="col-6">
        <table class="order-summary-table">
            <tr>
                <td>Nr. comanda intern</td>
                <td><%= relationships.doc_id.attributes.docnum %></td>
            </tr>
            <tr>
                <td>Denumire</td>
                <td>
                    <span class="display"><%= attributes.label %></span>
                    <span class="edit" style="min-width: 200px">
                        <input type="text" id="denumChange" class="form-control form-control-sm" value="<%= attributes.label %>">
                    </span>
                    <button class="btn btn-success float-right btn-sm save" onclick="saveDenumChange(this)"><i class="fa fa-save"></i></button>
                    <button class="btn btn-secondary float-right btn-sm edit" onclick="editDenumChange(this)"><i class="fa fa-edit"></i></button>
                </td>
            </tr>
            <tr>
                <td>Client</td>
                <td><a href="#" onclick="event.preventDefault(); goToPartner(this);"><%= relationships.partner_id.attributes.name %></a></td>
<!--                <td><a href="#" onclick="komponentor.intent('/views/customers/customer').data({id:0}).send()"><%= relationships.partner_id.attributes.name %></a></td>-->
            </tr>
            <tr>
                <td>Stadiu</td>
                <td>
                    <div class="btn-group">
<!--                        //     let states = ["offer", "ord", "proc", "ctc", "fix", "ready", "dlvd"];-->
<!--                        //     let normalized_states = ["Oferta", "Comandat", "In Lucru", "Control", "Corectii", "Gata de Livrare", "Livrat"];-->
<!--                        //     // let colors = ["orange", "red", "blue", "green", "black", "grey"];-->


                        <% if(attributes.state === "offer") { %>
                            <button type="button" class="btn btn-sm btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Oferta</button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" style="cursor:pointer;" onclick="changeState(this, `ord`)" value="ord">Comandat</a>
                            </div>
                        <% } else if(attributes.state === "ord") { %>
                            <button type="button" class="btn btn-sm btn-warning dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Comandat</button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" style="cursor:pointer;" onclick="changeState(this, `proc`)" value="proc">In Lucru</a>
                            </div>
                        <% } else if(attributes.state === "proc") { %>
                            <button type="button" class="btn btn-sm btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">In Lucru</button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" style="cursor:pointer;" onclick="changeState(this, `ready`)" value="ctc">Gata de Livrare</a>
                            </div>
                        <% } else if(attributes.state === "ready") { %>
                            <button disabled type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Gata de Livrare</button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" style="cursor:pointer;" onclick="changeState(this, `dlvd`)" value="dlvd">Livrat</a>
                            </div>
                        <% } else if(attributes.state === "dlvd") { %>
                            <button disabled type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Livrat</button>
                        <% } %>

                    </div>
                </td>
            </tr>
            <tr>
                <td>Echipa responsabila</td>
                <td>
                    <span class="display">
                    <% if(relationships.team) { %>
                        <%= relationships.team.attributes.name %>
                    <% } else { %>
                        nealocat
                    <% }  %>
                    </span>
                    <span class="edit" style="min-width: 200px">
                        <select id="teamAllocation" style="width: 150px">
                            <% if(relationships.team) { %>
                            <option value="<%= relationships.team.id %>"><%= relationships.team.attributes.name %></option>
                            <% }  %>
                        </select>
                    </span>
                    <button class="btn btn-success float-right btn-sm save" onclick="saveTeamAssoc(this)"><i class="fa fa-save"></i></button>
                    <button class="btn btn-secondary float-right btn-sm edit" onclick="editTeamAssoc(this)"><i class="fa fa-edit"></i></button>
                </td>

            </tr>
        </table>
    </div>
    <div class="col-6">
        <table class="order-summary-table">
            <tbody>
                <tr>
                    <td>Data preluare comanda</td>
                    <td><%= attributes.created_on %></td>
                </tr>
                <tr>
                    <td>Date dare in executie</td>
                    <td><%= attributes.startwork_on?attributes.startwork_on:"-" %></td>
                </tr>
                <tr>
                    <td>Data finalizare</td>
                    <td><%= attributes.readytodeliver_on?attributes.readytodeliver_on:"-" %></td>
                </tr>
                <tr>
                    <td>Data livrare</td>
                    <td><%= attributes.closed_on?attributes.closed_on:"-" %></td>
                </tr>
                <tr>
                    <td>Pret comanda</td>
                    <td><%= attributes.order_value ?  attributes.order_value + " " + (relationships.currency?relationships.currency.id:"-") : "-" %> </td>

                </tr>
                <tr>
                    <td>Pret calculat</td>
                    <td><%= attributes.calculated_value ?  attributes.calculated_value + " " + (relationships.currency ? relationships.currency.id:"-") : "-" %> </td>
                </tr>
                <tr>
                    <td>Pret final</td>
                    <td><%= attributes.final_value ?  attributes.final_value + " " + (relationships.currency ? relationships.currency.id:"-") : "-" %>  </td>
<!--                    <td><%= relationships.currency %>  </td>-->
                </tr>
            </tbody>
        </table>
    </div>
</div>


<script>
    function goToPartner(src){
        console.log(src);
        console.log($(src).data().instance.relationships.partner_id);
        komponentor.intent("/views/partners/addPartner").data({instance:$(src).data().instance.relationships.partner_id, title: "ceva"})
            .send();
    }

    function editDenumChange(src) {
        $(src).parent().addClass('editMode');
        // $("#teamAllocation").select2wrapper({url: apiRoot+"/teams",placeholder:"Aloca echipa",labelfld:"name"});
    }

    function saveDenumChange(src) {
        let $denum;
        $denum = $("#denumChange");


        $(src).parent().removeClass('editMode');
        // if(old_denum === $denum.val()){
        //     return;
        // }
        $(src).data("instance").update({label: $denum.val()}).then(function (a){
                console.log("saveDenumChangesaveDenumChangesaveDenumChange", $(src).data("instance"));
                // prepare_a(a.attributes.state);
            })
            .catch(function(data){
                komponentor.intent("/common/errormodal").data({
                    body: "A aparut o eroare:<pre>"+JSON.stringify(data.jqXHR.responseText)+"</pre>"
                }).send();
            });
    }

    function editTeamAssoc(src) {
        $(src).parent().addClass('editMode');
        $("#teamAllocation").select2wrapper({url: apiRoot+"/teams",placeholder:"Aloca echipa",labelfld:"name"});
    }

    function saveTeamAssoc(src) {
        $(src).parent().removeClass('editMode');
        let $teamalloc = $("#teamAllocation");
        $(src).data("instance").update({team: $teamalloc.val()}).then(function (a){
            console.log(a);
            // prepare_a(a.attributes.state);
        })
            .catch(function(data){
                komponentor.intent("/common/errormodal").data({
                    body: "A aparut o eroare:<pre>"+JSON.stringify(data.jqXHR.responseText)+"</pre>"
                }).send();
            });
    }

    function changeState(src, new_state){
        let instance = $(src).data("instance");
        instance.update({state: new_state}).catch(function (error) {
            komponentor.intent("/common/errormodal").data({
                body: "A aparut o eroare:<pre>"+JSON.stringify(error)+"</pre>"
            }).send();
        });
    }

    function init_komponent(k) {
        // $denum = $("#denumChange");
        // old_denum = $denum.val();
        console.log("lklklklklklkk", k);
        k.data.instance.setUrl(apiRoot+"/orders/"+k.data.instance.id+"?include=doc_id,partner_id,team,orders_meta&page[orders_meta][limit]=100")
            .bindView(k.$el.children()).loadFromRemote().then(function (d) {
            // prepare_a(k.data.instance.attributes.state);
                console.log(d)
            })
            .catch(function(data){
                komponentor.intent("/common/errormodal").data({
                    body: "A aparut o eroare:<pre>"+JSON.stringify(data.jqXHR.responseText)+"</pre>"
                }).send();
            });
    }
</script>