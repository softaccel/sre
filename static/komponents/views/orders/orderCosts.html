<style>

    .hide-no-offer{
        display: none;
    }

    .offer .hide-no-offer{
        display: unset;
    }

    .ord .hide-no-offer{
        display: unset;
    }

    .proc .hide-no-offer{
        display: unset;
    }
    a {
        cursor: pointer;
    }

</style>

<div class="checkRequired" data-module="orders" data-level="1">
    <div class="checkRead">
        <div class="content">

            <div class="row">
                <div class="col-3">
                    <!-- small box -->
                    <div class="small-box bg-gradient-secondary">
                        <div class="inner" id="orderCostsTotal" data-resourcetype="item" style="min-height: 120px">
                            <h4>Total</h4>
                            <div>
                                <h5><%= attributes.total%> <%= attributes.currency%></h5>
                            </div>
                        </div>
                        <div class="inner" id="orderCostsTotalEmpty" data-resourcetype="item" style="min-height: 120px">
                            <h4>Total</h4>
                            <div>
                                <h5>0</h5>
                            </div>
                        </div>

                        <a class="small-box-footer" onclick="filterCosts()">Afiseaza <i class="fas fa-arrow-circle-right"></i></a>
                    </div>
                </div>
                <div class="col-3">
                    <!-- small box -->
                    <div class="small-box bg-info">
                        <div class="inner" style="min-height: 120px">
                            <h4>Manopera</h4>
                            <div id="manoperaAgg">
                                <h5><%= attributes.qty %> <%= attributes.unit %> / <%= attributes.total %><%= attributes.currency %></h5>
                            </div>
                        </div>
                        <a class="small-box-footer" onclick="filterCosts('manopera')">Afiseaza <i class="fas fa-arrow-circle-right"></i></a>
                    </div>
                </div>
                <div class=" col-3">
                    <!-- small box -->
                    <div class="small-box bg-success">
                        <div class="inner" style="min-height: 120px">
                            <h4>Materiale</h4>
                            <div id="materialeAgg">
                                <h5><%= attributes.qty %> <%= attributes.unit %> / <%= attributes.total %><%= attributes.currency %></h5>
                            </div>
                        </div>
                        <div class="icon">
                            <i class="ion ion-stats-bars"></i>
                        </div>
                        <a class="small-box-footer" onclick="filterCosts('materii prime')">Afiseaza <i class="fas fa-arrow-circle-right"></i></a>
                    </div>
                </div>
                <div class=" col-3">
                    <!-- small box -->
                    <div class="small-box bg-warning">
                        <div class="inner" style="min-height: 120px">
                            <h4>Diverse</h4>
                            <div  id="diverseAgg">
                                <h5><%= attributes.qty %> <%= attributes.unit %> / <%= attributes.total %><%= attributes.currency %></h5>
                            </div>
                        </div>
                        <div class="icon">
                            <i class="ion ion-person-add"></i>
                        </div>
                        <a class="small-box-footer" onclick="filterCosts('diverse')">Afiseaza <i class="fas fa-arrow-circle-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="hide-no-offer">
            <button class="btn btn-primary checkUpdate" id="newCostEntryBtn"><i class="fa fa-plus"></i> Adauga</button>
        </div>
        <table class="table table-sm table-hover mt-2">
            <thead>
            <tr>
                <th>Denumire</th>
                <th>Grup</th>
                <th style="width: 130px">Cantitate</th>
                <th style="width: 130px">U.M.</th>
                <th style="width: 130px">Pret unitar</th>
                <th style="width: 130px">Total</th>
<!--                <th style="width: 130px">Total cu TVA</th>-->
                <th style="width: 50px"></th>
            </tr>
            </thead>
            <tbody id="orderCostsList" data-resourcetype="collection">
            <tr>
                <td><%= attributes.name %></td>
                <td><%= attributes.grouping %></td>
                <td><%= attributes.qty %></td>
                <td><%= relationships.unit.id %></td>
                <td><%= attributes.unit_price %> <%= relationships.currency.id %></td>
                <td><%= attributes.total %> <%= relationships.currency.id %></td>
<!--                <td><%= attributes.total_wvat %> <%= relationships.currency.id %></td>-->
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-warning" onclick="editCost(this)"><i class="fa fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCost(this)"><i class="fa fa-trash"></i></button>
                    </div>
                </td>
            </tr>
            </tbody>

            <tfoot id="orderCostsTotal1"  class="font-weight-bold d-none">
            <tr>
                <td>Total</td>
                <td colspan="4"></td>
                <td><%= attributes.total%></td>
            </tr>
            <tr>
                <td>TVA</td>
                <td colspan="4"></td>
                <td><%= Math.round((attributes.total_wvat - attributes.total)*100)/100%></td>
            </tr>
            <tr>
                <td>Total + TVA</td>
                <td colspan="4"></td>
                <td><%= attributes.total_wvat%></td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>

<script>

    function deleteCost(src) {
        let instance = $(src).parent().parent().data("instance");
        komponentor.intent("/common/messagemodal").data({
            body:"Sigur vrei sa elimini elementul <strong>"+instance.attributes.name+"</strong>?",
            buttons:[
                {
                    label: "Da",
                    attrs: {
                        "data-dismiss": "modal",
                    },
                    class: "btn btn-danger",
                    callback: function () {
                        instance.delete().catch(function(data){
                            komponentor.intent("/common/errormodal").data({
                                body: "A aparut o eroare:<pre>"+data.jqXHR.responseText+"</pre>"
                            }).send();
                        });
                    }
                },
                {
                    label: "Nu",
                    attrs: {
                        "data-dismiss": "modal",
                    },
                    class: "btn btn-secondary",
                }
            ]
        }).send();
    }

    function editCost(src) {
        komponentor.intent("/views/orders/costs/newcost").data({instance:$(src).data().instance,cb:()=>{$("#orderCostsTotal").data().instance.loadFromRemote()}}).send();
    }

    function filterCosts(filter) {
        let instance = $("#orderCostsList").data("instance");
        if(typeof filter==="undefined")
            delete instance.url.parameters.filter;
        else
            instance.url.parameters.filter = "grouping="+filter;
        instance.loadFromRemote();
        console.log(instance);
    }

    function init_komponent(k) {

        k.$el.addClass(k.data.instance.attributes.state);

        let costsListIntance = $("#orderCostsList").apiator({returninstance:true}).setUrl(apiRoot+"/orders/"+k.data.instance.id+"/orders_costs");
        costsListIntance.loadFromRemote().then(function () {
            if(costsListIntance.items.length) {
                $("#orderCostsTotal").show().apiator({returninstance: true,emptyview: "#orderCostsTotalEmpty" }).setUrl(apiRoot + "/orders_costs_total/" + k.data.instance.id).loadFromRemote();
                $("#orderCostsTotalEmpty").hide();
            }
            else {
                $("#orderCostsTotal").hide();
                $("#orderCostsTotalEmpty").show();
            }
        });
        $("#diverseAgg").apiator({url:apiRoot+"/orders/2/orders_costs_aggregated?filter=grouping=diverse",resourcetype: "collection"});
        $("#manoperaAgg").apiator({url:apiRoot+"/orders/2/orders_costs_aggregated?filter=grouping=manopera",resourcetype: "collection"});
        $("#materialeAgg").apiator({url:apiRoot+"/orders/2/orders_costs_aggregated?filter=grouping=materii%20prime",resourcetype: "collection"});

        $("#newCostEntryBtn").on("click",function () {
            komponentor.intent("/views/orders/costs/newcost").data({instance:costsListIntance,cb:()=>{$("#orderCostsTotal").data().instance.loadFromRemote()}}).send();
        });


    }
</script>