<style>

    #orderPartDetailsList tr input,
    #orderPartDetailsList tr textarea,
    #orderPartDetailsList tr button.edit,
    #orderPartDetailsList tr select {
        display: none;
    }
    #orderPartDetailsList tr.edit p,
    #orderPartDetailsList tr.edit button {
        display: none;
    }
    #orderPartDetailsList tr.edit input,
    #orderPartDetailsList tr.edit textarea,
    #orderPartDetailsList tr.edit button.edit,
    #orderPartDetailsList tr.edit select {
        display: unset;
    }

    .elli {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

</style>

<div id="orderPartDetails">
    <form id="orderPartDetailsFilter" class="d-none"> <button type="submit" name="submit" id="submitButton"></button> </form>
    <table class="table table-striped table-hover" style="table-layout: fixed">
        <thead class="thead-dark" id="orderPartDetailsHeader">
        <tr>
            <th class="align-top" style="width: 400px">
                <a class="text-white" data-sortfld="label">Denumire</a>
                <input type="text" name="meta_key" class="form-control-sm form-control" form="orderPartDetailsFilter" data-operator="~=~">
            </th>
            <th class="customerColumn align-top" style="min-width: 500px">
                <a class="text-white">Valoare</a>
            </th>
            <th width="100px"></th>
        </tr>
        </thead>
        <tbody id="orderPartDetailsList"
               data-filter="#orderPartDetailsFilter"
               data-sort="#orderPartDetailsHeader">
            <tr class="order <%= attributes.state %>">
                <td><%= attributes.meta_key %></td>
                <td>
                    <p class="elli"> <%= attributes.meta_val %> </p>
                    <textarea id="metaEdit" name="meta_val" rows="2" cols="35"></textarea>
                </td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="edit(this)"><i class="fa fa-edit"></i> </button>
                    <button class="btn btn-primary btn-sm edit" onclick="save(this)"><i class="fa fa-save"></i> </button>
                    <button class="btn btn-secondary btn-sm edit" onclick="cancelEdit(this)"><i class="fa fa-arrow-left"></i> </button>
                </td>
            </tr>

        </tbody>
    </table>
</div>

<script>

    function cancelEdit(src) {
        $(src).parents('tr').removeClass('edit');
    }

    function edit(src) {
        let itemContainer = $(src).parents("tr").addClass("edit");
        let instance = $(src).data("instance");
        itemContainer.find("textarea[name=meta_val]").val(instance.attributes.meta_val);
    }

    function save(src) {
        let meta_val = $(src).parents("tr").find("textarea[name=meta_val]").val();
        let instance = $(src).data("instance");

        instance.update({
            meta_val: meta_val
        }).catch(function (e) {
            komponentor.intent("/common/errormodal").data({body: "Eroare: <pre>" + e.jqXHR.responseText + "</pre>"}).send();
        });
    }

    function init_komponent(k) {

        $("#orderPartDetailsList").apiator({
            type: "inventory_meta",
            resourcetype: "collection"
        }).data("instance").setUrl(apiRoot + "/orders_items/" + k.data.instance.id + "/orders_items_meta/").loadFromRemote();

        let submitButton = $("#orderPartDetailsFilter").find("#submitButton");
        $("#orderPartDetailsHeader").find("input").on("input", function () {
            submitButton.click();
        });

    }

</script>