<style>

</style>

<div class="modal" id="order_form_modal">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Comanda noua</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form name="importForm" id="importForm">
                    <input type="file" name="orderfile">
                </form>

                <form name="orderForm" id="orderForm" style="display: none">
                    <div class="position-relative form-group">
                        <label for="partner_id" class="">Client</label>
                        <select name="partner_id" id="partner_id" class="js-example-basic-single" style="width: 100%;" required>
                        </select>
<!--                        <input type="text" class="form-control">-->
                    </div>
                    <div class="position-relative form-group">
                        <label for="cust_int_ref" class="">Referinta Interna Client</label>
                        <input name="cust_int_ref" id="cust_int_ref"  type="text" class="form-control" required>
                    </div>
                    <div class="position-relative form-group">
                        <label for="multiplied_by" class="">Cantitate</label>
                        <input name="multiplied_by" id="multiplied_by"  type="number" value="1" class="form-control">
                    </div>
                    <div class="position-relative form-group">
                        <label for="model" class="">Descriere</label>
                        <input name="model" id="model"  type="text" class="form-control">
                    </div>
                    <div class="position-relative form-group">
                        <label for="orderdate" class="">Data comenzii</label>
                        <input name="orderdate" id="orderdate"  type="date" class="form-control">
                    </div>
                    <div class="position-relative form-group">
                        <label for="deliverydate" class="">Data estimata a livrarii</label>
                        <input name="deliverydate" id="deliverydate" type="date" class="form-control">
                    </div>
                    <div class="position-relative form-group">
                        <label for="estimated_effort" class="">Timp executie estimat</label>
                        <input name="estimated_effort" id="estimated_effort"  type="number" class="form-control" required>
                    </div>

                    <div style="max-height: 500px; overflow: scroll;">
                        <table class="table table-striped table-sm">
                            <thead>
                            <tr>
                                <th><input type="checkbox" checked name="toggleall" data-toggle="cod" onclick="toggleCheck(this)"></th>
                                <th>Cod</th>
                                <th>Descriere</th>
                                <th>Cantitate</th>
                                <th>Pret unitar</th>
                                <th>Total</th>
                                <th>Altele</th>
                            </tr>
                            </thead>
                            <tbody data-name="orderItems">
                            <tr>
                                <td><input type="checkbox" name="cod" data-toggleall="toggleall" value="<%= cod %>" checked onclick="toggleCheck(this)"></td>
                                <td><%= cod %></td>
                                <td><%= desc %></td>
                                <td><%= qty %> <%= unit %></td>
                                <td><%= unit_price %><%= curr %></td>
                                <td><%= total %><%= curr %></td>
                                <td onmouseover="show(this)">
                                    <div class="d-none">
                                        <ul>
                                            <% for(let i in others.fields) { %>
                                            <% if (others.fields[i].type=='data') %>
                                            <li><strong><%= i %> :</strong> <%= others.fields[i].data %></li>
                                            <% }%>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="position-relative form-group">
                        <label for="calculated_valueInput" class="">Valoare total estimata</label>
                        <input name="calculated_value" id="calculated_valueInput"  type="number" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button data-name="uploadButton" form="importForm" type="button" class="btn-primary btn">Importa XML</button>
                <button data-name="placeOrderButton" form="orderForm" type="button" class="btn btn-success" style="display: none">Creaza comanda</button>
            </div>
        </div>
    </div>
</div>

<script>
    function show(src) {
        // $(src.)
    }

    function toggleCheck(src) {

        let checked = src.checked;

        // toggleAll checkbox was pressed
        let toggleTarget = $(src).attr("data-toggle");
        if(toggleTarget) {
            $(src.form).find("input[name="+toggleTarget+"]").each(function () {
                $(this)[0].checked = checked;
            });
            return;
        }

        let toggleAll = src.form[$(src).data("toggleall")];
        if(!checked) {
            toggleAll.checked = false;
            return;
        }

        let allchecked = true;
        let inputs = $(src.form).find("input[name="+src.name+"]");
        for(let i =0;i<inputs.length;i++) {
            if(!inputs[i].checked) {
                allchecked = false;
                break;
            }
        }
        toggleAll.checked = allchecked;

    }

    function init_komponent(k) {

        let orderMeta;
        function init_partner_select() {
            $("select[name=partner_id]").select2wrapper({url: apiRoot+"/partners",labelfld:"name"});
        }

        let $items = k.$el.find("[data-name=orderItems]");
        let templateTxt = $items.html().replace(/&lt;/gi, '<').replace(/&gt;/gi, ">");
        let template;
        if(templateTxt) {
             template = _.template(templateTxt);
        }
        $items.empty();

        let modal = k.$el.appendTo("body").filter(".modal");
        modal.on("hidden.bs.modal",function (e) {
            k.$el.remove();
        });
        let $orderButton = k.$el.find("[data-name=placeOrderButton]");
        let $uploadButton = k.$el.find("[data-name=uploadButton]");

        let orders = k.data.instance;

        let valuesMap = {
            E: "EUR",
            Stk: "buc"
        };

        function publishHeader(response) {
            let sectionIDs = Object.getOwnPropertyNames(response.sections);
            let bestellung = null;
            // let sections = [];
            let order = null;
            orderMeta = [];

            for (let i=0;i<sectionIDs.length;i++) {
                if (response.sections[sectionIDs[i]].SectionKey==="K.F") {
                    bestellung = response.sections[sectionIDs[i]];
                }

                if (response.sections[sectionIDs[i]].SectionKey==="K.E") {
                    order = response.sections[sectionIDs[i]];
                }

                // if(response.sections[sectionIDs[i]].SectionKey==="P.A") {
                //     sections.push(response.sections[sectionIDs[i]]);
                // }

                if (response.sections[sectionIDs[i]].SectionKey==="P.A") {
                    continue;
                }

                for (let fldName in response.sections[sectionIDs[i]].fields) {
                    orderMeta.push({
                        meta_key: fldName,
                        meta_val: response.sections[sectionIDs[i]].fields[fldName].data
                    });
                }
            }

            if (bestellung===null) {
                return;
            }

            let instance = $("<div>").apiator({resourcetype: "collection",returninstance:true});
            instance.setUrl(apiRoot + "/partners/?filter=name~=~" + encodeURIComponent(order.fields["K.E.Lief_Adresse.PF_AdrRow1"].data)).loadFromRemote().then(function (data) {
                if (instance.items.length == 1 && instance.items[0].attributes && instance.items[0].attributes.name)
                    $("#partner_id").empty().append("<option value='" + instance.items[0].id+ "'>"
                        + instance.items[0].attributes.name + "</option>");
            });

            $("#model").val(order.fields["K.E.E_BelegKopf.BelegInfo"].data);

            let dateSplit = bestellung.fields["K.F.E_BelegKopf.BelegDatum"].data.split('.');
            $("#orderdate").val(dateSplit[2] + "-" + dateSplit[1] + "-" + dateSplit[0]);
        }

        function publishItems(response) {

            let total = 0;
            let entries = [];
            let targetDateSet = false;
            Object.getOwnPropertyNames(response.sections).forEach(function (sectionId) {
                let entry = response.sections[sectionId];

                if (entry.SectionKey==="P.A") {
                    if (!targetDateSet && entry.fields["P.A.E_BelegPos.WunschTermin"]) {
                        let dateSplit = entry.fields["P.A.E_BelegPos.WunschTermin"].data.split('.');
                        $("#deliverydate").val(dateSplit[2] + "-" + dateSplit[1] + "-" + dateSplit[0]);
                        targetDateSet = true;
                    }

                    let entryData = {
                        cod: entry.fields["P.A.E_BelegPos.Artikel"].data,
                        desc: entry.fields["P.A.S_ArtikelSpr.Bezeichnung[1]"].data+" / " +entry.fields["P.A.S_ArtikelSpr.Bezeichnung[2]"].data+" / "
                            +entry.fields["P.A.S_ArtikelSpr.Bezeichnung[3]"].data+" / " +entry.fields["P.A.S_ArtikelSpr.Bezeichnung[4]"].data,
                        unit_price: entry.fields["P.A.E_BelegPos.Einzelpreis"].data.replaceAll(".","").replaceAll(",",".")*1,
                        qty: entry.fields["P.A.E_BelegPos.Menge"].data.replaceAll(".","").replaceAll(",",".")*1,
                        curr: entry.fields["P.A.S_PreisEinheitSpr.KurzBez"].data,
                        unit: entry.fields["P.A.S_MengenEinheitSpr.KurzBez"].data,
                        total: entry.fields["P.A.E_BelegPos.Warenwert"].data.replaceAll(".","").replaceAll(",",".")*1,
                        others: entry
                    };
                    entries.push(entryData);
                    total += entryData.total;
                }
            });

            entries.forEach(function (entry) {
                let $el = $(template(entry)).appendTo($items).data("instance",entry);
                $el.find("*").data("instance",entry);
            });
        }

        function uploadFile(form) {
            let files = form.orderfile.files;
            $items.empty();

            if(files.length<1) {
                console.log("no files");
                return;
            }

            let fd = new FormData();
            fd.append("file",files[0]);
            return new Promise(function (resolve, reject) {

                $.ajax({
                        url: backendUrl+"/main/XMLtoJSON",
                        data: fd,
                        type: "post",
                        contentType: false,
                        processData: false,
                    })
                    .done(function(response) {
                        publishItems(response);
                        publishHeader(response);
                        init_partner_select();
                        resolve();
                    })
                    .fail(function () {
                        reject();
                    })
            });
        }

        function placeOrder(form) {
            orderMeta.push({meta_key: "estimated_effort", meta_val: $(form.estimated_effort).val()});

            let order = {
                attributes: {
                    label: $(form.model).val(),
                    partner_id: $(form.partner_id).val(),
                    cust_int_ref: $(form.cust_int_ref).val(),
                    user_id: userData.sub,
                    calculated_value: $(form.calculated_value).val(),
                    orders_items: [],
                    orders_meta: orderMeta
                }
            };

            let total = 0;
            $(form).find("input[name=cod]").filter(":checked").each(function () {
                let instance = $(this).data("instance");
                let order_part = {
                    type: "orders_items",
                    attributes:
                        {
                            unit: valuesMap[instance.unit],
                            name: instance.desc,
                            qty: parseInt(instance.qty) * parseInt($("input[name=multiplied_by]").val()),
                            unit_price: instance.unit_price,
                            currency: valuesMap[instance.curr],
                            orders_items_meta: []
                        },
                };
                for (let key in instance.others.fields) {

                    if(instance.others.fields[key].data!=="") {
                        order_part.attributes.orders_items_meta.push({
                            type: "orders_items_meta",
                            attributes: {
                                meta_key: key,
                                meta_val: instance.others.fields[key].data
                            }
                        });
                    }
                }

                order.attributes.orders_items.push(order_part);
                total += instance.qty*instance.unit_price;
            });

            order.attributes.multiplied_by = $("input[name=multiplied_by]").val();
            order.attributes.order_value = total * order.attributes.multiplied_by;
            return orders.createItem(order);
        }

        $orderButton.on("click",function (src) {
            let suspend = false;
            $("#orderForm").find("input,textarea,select").filter("[required]").each(function () {
                if (!$(this).val() || $(this).val() === '' || $(this).val() === null)
                    suspend = true;
            });

            if (suspend) {
                komponentor.intent("/common/errormodal").data({body: "Eroare: <pre>Toate campurile sunt obligatorii.</pre>"}).send();
                return;
            }

            placeOrder(src.target.form)
                .then(function (a) {
                    k.data.instance.view.el.children().first().find("td:nth-child(2)").click();
                    modal.modal("hide");
                })
                .catch(function (resp) {
                    komponentor.intent("/common/errormodal").data({body: "Eroare: <pre>" + resp.jqXHR.responseText + "</pre>"}).send();
                })
        });

        $uploadButton.on("click",function (src) {
            uploadFile(src.target.form)
                .then(function () {
                    $($uploadButton.hide()[0].form).hide();
                    $($orderButton.show()[0].form).show();
                })
                .catch(function(data){
                    komponentor.intent("/common/errormodal").data({
                        body: "A aparut o eroare: <pre>"+data.jqXHR.responseText+"</pre>"
                    }).send();
                });
        });

        k.exec = function (data) {
            modal.modal("show");
        };
        k.exec();
    }
</script>