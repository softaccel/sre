<div class="modal" id="order_file_modal">
    <div class="modal-dialog">
        <form>
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group text">
                    <label></label>
                    <input type="text" class="form-control-sm form-control" autocomplete="off">
                    <datalist></datalist>
                </div>
                <div class="form-group number">
                    <label></label>
                    <input type="number" class="form-control-sm form-control">
                </div>
                <div class="form-group date">
                    <label></label>
                    <input type="date" class="form-control-sm form-control">
                </div>
                <div class="form-group checkbox">
                    <input type="checkbox" class="form-check-input">
                    <label></label>
                </div>
                <div class="form-group datetime">
                    <label></label>
                    <input type="datetime-local" class="form-control-sm form-control">
                </div>
                <div class="form-group select">
                    <label></label>
                    <select class="custom-select custom-select-sm" style="width: 100%"></select>
                </div>
                <div class="form-group textarea">
                    <label></label>
                    <textarea class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success" >Salveaza</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Renunta</button>
            </div>
        </div>
        </form>
    </div>
</div>

<script>
    function init_komponent(k) {
        let modalData = {
            title: null,
            size: null,
            callback: new Function()
        };

        Object.assign(modalData,k.data);

        if(!modalData.fields) {
            console.log("No fields provided");
            return;
        }


        let modal = k.$el.appendTo("body")
            .filter(".modal")
            .on("hidden.bs.modal",function () {
                k.$el.remove();
            });


        k.hide = function() {
            modal.modal("hide");
        };

        if(modalData.size) {
            modal.find(".modal-dialog").addClass("modal-"+modalData.size);
        }

        if(modalData.title===null) {
            modal.find(".modal-header").remove();
        }
        else {
            modal.find(".modal-title").html(modalData.title);
        }

        let body = k.$el.find(".modal-body");

        let template = body.children().remove();

        k.$el.find("form").on("submit",function (e) {
            e.preventDefault();
            let data = {};
            for(let i=0;i<e.target.elements.length;i++) {
                let $el = $(e.target.elements[i]);

                if($el.attr("name")) {

                    data[$el.attr("name")] = $el.val();
                }
            }

            modalData.callback({k: k, data: data});
            if(typeof modalData.autoClose==="undefined" || modalData.autoClose===true) {
                modal.modal("hide");
            }

        });


        let tags = {
            date:"input",
            datetime:"input",
            number:"input",
            text:"input",
            checkbox:"input",
            select:"select",
            textarea:"textarea",
        };

        modalData.fields.forEach(function (fld) {
            if (!fld.type) {
                return;
            }

            let tpl = $(template.filter("."+fld.type).clone());
            if (!tpl.length) {
                return;
            }

            tpl.appendTo(body);

            if (fld.label) {
                tpl.find("label").html(fld.label);
            } else {
                tpl.find("label").remove();
            }

            let inp = tpl.find(tags[fld.type]);

            if (fld.default && fld.type!=="select") {
                inp.val(fld.default);
            }

            if (fld.name) {
                inp.attr("name",fld.name);
            }

            if (fld.placeholder && fld.type!=="select") {
                inp.attr("placeholder",fld.placeholder);
            }

            if (fld.pattern && fld.type === "text"){
                inp.attr("pattern", fld.pattern);
            }

            if(fld.attrs) {
                for(let attrName in fld.attrs) {
                    inp.attr(attrName,fld.attrs[attrName]);
                }
            }

            if(fld.type==="text" && typeof  fld.options!== "undefined" && fld.options.constructor===Array) {
                let dl = tpl.find("datalist");
                dl.attr("id",fld.name+"options");
                inp.attr("list",fld.name+"options");
                // inp.removeAttr("autocomplete");
                fld.options.forEach(function (item) {
                    $("<option>").val(item).appendTo(dl);
                })
            }

            /*
                select type

                mandatory: {type: "select", name: "", label: ""} +
                    manual options -> {options: [{id: "", description: ""}]}
                    or
                    select2wrapper -> {url: "/", labelfnc: function or string, idfnc: function or string}

                    example:
                        labelfnc/idfnc: function (item) {
                            return item.attributes.name + " - " + item.attributes.city;
                        }

                        searchfnc: function (params) {
                            return "name" + "~=~" + params.term;
                        }


                optional: {placeholder: "", default: {id: "", description: ""}, dependent: "~name attr of another select~"}
            */
            if (fld.type==="select") {

                let hasDefault = fld.default && (fld.default.id || fld.default.value);
                if (hasDefault) {
                    let option = $("<option>");
                    option
                        .val(fld.default.value ? fld.default.value : fld.default.id)
                        .text(fld.default.label ? fld.default.label : (fld.default.description ? fld.default.description : option.value))
                        .appendTo(inp);
                }

                if (!fld.options || fld.options.length <= 0) {
                    if (!fld.url || !fld.labelfnc || !fld.idfnc)
                        throw new Exception("FormModal - invalid use of the select type.");

                    inp.select2wrapper({
                        url: apiRoot + fld.url,
                        labelfld: fld.labelfnc,
                        searchfld: fld.searchfnc ? fld.searchfnc : "",
                        idfld: fld.idfnc,

                        placeholder: fld.placeholder ? fld.placeholder : ""
                    });
                    if(fld.onselect){
                        inp.on("select2:select", fld.onselect);
                    }

                }
                else {

                    fld.options.forEach(function (option) {
                        if (!hasDefault || (hasDefault && option.id !== fld.default.id && option.description !== fld.default.description) ) {
                            let optionElement = document.createElement("option");
                            optionElement.value = option.value ? option.value : option.id;
                            optionElement.text = option.label ? option.label : (option.description ? option.description : optionElement.value);
                            inp.append(optionElement);
                        }
                    });

                    inp.select2();
                    if (!hasDefault) {
                        inp.val('').change();
                    }
                }

                if (fld.dependent) {

                    let inpGroup = inp.parent();
                    let parent = $("#order_file_modal").find("select[name=" + fld.dependent + "]");
                    let parentData = parent.select2('data');

                    if (!parentData || !parentData.length) {
                        inpGroup.hide();
                    }

                    parent.on("select2:select", function () {
                        inpGroup.show();
                    });

                    parent.on("select2:clear", function () {
                        inpGroup.hide();
                    });
                }
            }

        });

        modal.modal();
    }
</script>


