<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta content="utf-8" http-equiv="encoding">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Language" content="en">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>SRE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no" />
    <!--    <base href="/" />-->
    <!--    <meta name="description" content="This is an example dashboard created using build-in elements and components.">-->
    <meta name="msapplication-tap-highlight" content="no">
    <meta content="no-cache, no-store, must-revalidate" http-equiv="Cache-Control"/>
    <meta content="no-cache" http-equiv="Pragma"/>
    <meta content="0" http-equiv="Expires"/>
    <!--    <link href="main.css" rel="stylesheet">-->
    <!--    <link href="https://adminlte.io/themes/AdminLTE/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">-->

    <link rel="stylesheet" href="assets/fontawesome/css/all.min_adminlte.css">

    <link href="assets/css/adminlte.css" rel="stylesheet">
    <link href="assets/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet">
    <link href="assets/css/icheck-bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">

<!--    <link href="adminlte.min.css" rel="stylesheet">-->

    <link href="assets/css/spinner.css" rel="stylesheet">
    <link href="assets/css/jquery-ui.css" rel="stylesheet">
    <!--    <link href="assets/css/selectize.bootstrap3.css" rel="stylesheet">-->
    <link href="assets/css/select2.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300&display=swap" rel="stylesheet">
    <link href="assets/css/bootstrap4-toggle.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="assets/css/daterangepicker.css" />

    <style>
        body {
            font-size: 0.9rem;
            font-family: 'Poppins', sans-serif;        }
        .card-header{
            display: flex;
            align-items: center;
        }
        .card-header>*{
            display: flex;

        }
        .card-header .nav {
            display: flex;
            width: auto;
            margin-left: auto;
        }

        .modal-header{
            display: flex;
            align-items: center;
        }
        .modal-header>*{
            display: flex;
        }
        .modal-title{
            font-size: 1.2rem;
            font-weight: bold;
        }
        .nav-pills{
            font-weight: bold;
        }

    </style>
</head>
<body  class="sidebar-mini layout-fixed" data-panel-auto-height-mode="height" style="height: auto;">

<div class="wrapper" id="page">
</div>


<script src="assets/js/jquery.js"></script>
<script src="assets/js/jwt-decode.js"></script>
<script src="assets/js/komponentor.js?v=1"></script>
<script src="assets/js/popper.min.js"></script>
<script src="assets/js/bootstrap.bundle.js"></script>
<script src="assets/js/jquery-ui.js"></script>
<script src="assets/js/underscore-min.js"></script>
<script src="assets/js/apiator.js"></script>
<script src="assets/js/jquery.scannerdetection.js"></script>
<script src="assets/js/select2.min.js"></script>
<script src="assets/js/select2wrapper.js"></script>
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.js"></script>
<script src="assets/js/label_printer.js"></script>
<script type="text/javascript" src="assets/js/moment.min.js"></script>
<script type="text/javascript" src="assets/js/daterangepicker.js"></script>

<script>
    /**
     * setarea environment-ului se face in Consola cu
     * localStorage.setItem("spaleck.env","denumire_environment")
     *
     * Evident "denumire_environment" trebuie sa se regaseasca in env_config de mai jos
     */

    const localStorageLabel = "spaleck";
    // let env = localStorage.getItem(localStorageLabel+".env");
    // if(!env || !env_config[env])
    //     env = "sergiu_devel";
    // console.log(env_config[env]);

    const _kPath = "komponents";
    const _kExt = ".html";
    const vPath = _kPath+"views/";
    let defaultView = "/views/dashboard";

</script>
<script>
    function logout() {
        userData = null;
        localData.jwt  = null;
        localStorage.setItem("spaleck",JSON.stringify(localData));
        location = location.pathname;
    }

    function checkAuth() {
        let localData = {

        };
        let userData;
        Object.assign(localData,JSON.parse(localStorage.getItem(localStorageLabel)));

        if(localData.jwt) {
            try {
                userData = jwt_decode(localData.jwt);
                let d = new Date();
                if(d.getTime()/1000>userData.exp) {
                    logout();
                }
            }
            catch($e) {
                // console.log($e);
            }
        }
        return [localData,userData];
    }

    function toggleAll(src) {
        let checked = $(src).prop("checked");
        $($(src).data("connected")).children().each(function (i) {
            toggleSelect(this,checked);
        });
    }

    function toggleSelect(src,state) {
        state = state!==undefined?state:!$(src).hasClass('selected');
        $(src).find("input[type=checkbox]").prop("checked",state);
        if(state) {
            $(src).addClass('selected').find("input[type=checkbox]").prop("checked",true);
        }
        else {
            $(src).removeClass('selected');
        }
        let tmp = $("#orderPartsList").children();
        $($(src).data("connected")).prop("checked",(tmp.length===tmp.filter(".selected").length));
    }

    function checkUserRights(el, modules) {
        console.log(modules);

        let checkRights = function (module) {
            let rights = allRights[module];
            if (rights.indexOf("r") === -1) {
                // todo: show not enough rights
                return;
            }
            el.find(".module-"+module)

            el.find(".checkRead").each(function () {
                // $(this).removeClass("checkRead");
                $(this).addClass("readAllow");
            });

            if (rights.indexOf("c") !== -1) {
                el.find(".checkCreate").each(function () {
                    $(this).addClass("createAllow");
                });
            }

            if (rights.indexOf("u") !== -1) {
                el.find(".checkUpdate").each(function () {
                    $(this).addClass("updateAllow");
                });
            }

            if (rights.indexOf("d") !== -1) {
                el.find(".checkDelete").each(function () {
                    $(this).addClass("deleteAllow");
                });
            }
        };

        let allRights = JSON.parse(localStorage.getItem("rights"));

        if (typeof modules === "string") {
            checkRights(modules);
            return;
        }
        if(typeof modules==="undefined") {
            console.log("undefine modules",el);
            return;
        }

        if(typeof modules==="object") {
            console.log("invalid modules",el);
            return;
        }



        modules.forEach(function (module) {
            checkRights(module);
        });

    }

    // let localData,userData;
    let [localData,userData] = checkAuth();



    autoload = false;
    let backendUrl, apiRoot, authUrl, fileApiUrl;


    let p1 = new Promise((resolve,reject)=>
        $.get("../environments.json")
            .done(function (data) {
                resolve(data);
            })
            .fail(function (data) {
                reject(data);
            })
    );
    let p2 = new Promise((resolve,reject)=>
        $.get("../active_env.json")
            .done(function (data) {
                resolve(data);
            })
            .fail(function (data) {
                reject(data);
            })
    );


    Promise.all([p1,p2]).then((values)=>{
        let environments = values[0];
        let active = values[1].active;
        console.log(environments,active);
        backendUrl = environments[active].backendUrl;
        apiRoot = environments[active].feDBapiUrl;
        authUrl = environments[active].authUrl;
        fileApiUrl = environments[active].fileApiUrl;

        let url = "/views/app";
        if(!userData) {
            url = "/views/login";
        }
        $("#page").komponent({url:url,replace:false}).finally(function () {
            $(".pageOverlay").remove();
        });
    })
        .catch(()=>{
            alert("Failed to load configuration");
        });


</script>
<script>


</script>

<style>
    .checkRead {
        display: none;
    }
    .checkCreate {
        display: none;
    }
    .checkUpdate {
        display: none;
    }
    .checkDelete {
        display: none;
    }

    .checkRead.readAllow {
        display: block;
    }
    .checkCreate.createAllow {
        display: block;
    }
    .checkUpdate.updateAllow {
        display: block;
    }
    .checkDelete.deleteAllow {
        display: block;
    }

</style>
<script>



</script>

</body>
</html>
